# Imports
from vital import *


# Metadatas
ARGUMENTS["platform_type"] = ARGUMENTS.get("platform_type", "Server")
ARGUMENTS["build_type"] = ARGUMENTS.get("build_type", "Debug")


# Environments
os_info = Fetch_OS()
cwd = os.path.abspath(os.getcwd())
env = Environment(tools=Fetch_Compiler(), PLATFORM="")
env.Args = ARGUMENTS
env.Build_Module()
env.MergeFlags(SConscript(".conan/SConscript_conandeps")["conandeps"])
env.sources = (
    env.RGlob("Type", "*.cpp") + 
    env.RGlob("System", "*.cpp") + 
    env.RGlob("Sandbox", "*.cpp") + 
    env.RGlob("Vendor", "*.cpp") + 
    env.RGlob("Vendor", "*.c") + 
    env.RGlob("Vendor", "*.cc")
)
env.Append(CPPPATH=[
    cwd,
    os.path.join(cwd, "Type"),
    os.path.join(cwd, "System"),
    os.path.join(cwd, "Sandbox"),
    os.path.join(cwd, "Vendor"),
    os.path.join(cwd, "Vendor/fmt"),
    os.path.join(cwd, "Vendor/msgpack"),
    os.path.join(cwd, "Vendor/rapidjson"),
    os.path.join(cwd, "Vendor/lua"),
    os.path.join(cwd, "Vendor/duktape"),
    os.path.join(cwd, "Vendor/discord-sdk")
])


# Flags
if ARGUMENTS["platform_type"] == "Client":
    env.Append(CPPDEFINES=["Vital_SDK_Client"])


# Dependencies
env.Append(CPPDEFINES=["MSGPACK_NO_BOOST"])
if os_info["type"] == "Windows":
    env.Append(CPPDEFINES=["Vital_SDK_WINDOWS"])
    env.Append(CPPFLAGS=["/EHsc"])
    env.Append(LIBS=["ws2_32", "winmm", "wbemuuid"])
elif os_info["type"] == "Darwin":
    env.Append(CPPDEFINES=["Vital_SDK_MACOS"])
    env.Append(CPPDEFINES=["LUA_USE_MACOSX", "DUK_F_APPLE", "HAS_SOCKLEN_T"])
elif os_info["type"] == "Linux":
    env.Append(CPPDEFINES=["Vital_SDK_LINUX"])
    env.Append(CPPDEFINES=["LUA_USE_LINUX", "DUK_F_LINUX", "HAS_SOCKLEN_T"])


# Returns
Return("env")